---
title: "Explore Neuro/Psychiatric PheWAS Codes"
author: 'Meg Hutch'
date: '2022-05-03'
output:
  html_document:
    toc: true
    toc_float: true
    code_download: true
    theme: spacelab
---

**Evaluation of Neurological and Psychiatric PheWAS Codes and their association with PASC**

Notes:

- will have to adapt this better for sites with ICD-9

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(plotly)
library(DT)
library(stringr)
library(survival)

siteid = "NWU"
# change to the directory of you Phase2.2 LocalPatientObservations.csv file
input_dir = "/share/fsmresfiles/nm_cvd/4CE/PhaseX.2/Input/LocalPatientObservations.csv"
```

# Import Phase2.2 Data

```{r}
# ensure this directs to the input directory where Phase2.2 data files are stored
observations <- read.csv(input_dir)

observations <- observations %>% 
  filter(concept_type == 'DIAG-ICD10' | concept_type == 'DIAG-ICD9')
```

# Evaluate Harrison Zhang's codes

Harrison provided a list of PheCodes or "phenotypes whose new onset is conditionally dependent on exposure to the virus 90 or 180 days prior to new onset. Thus, we're identifying phenotypes that we believe are forms of PASC - thus, these codes could be considered a proxy for PASC".

```{r}
# load in phecodes from HZ's analysis
neuro_phecodes <- read.csv("data/2022-04-13_dCRT_meta_logistic_beta_pos_results_unique_sig_codes_MS_ZX.csv") %>% 
  filter(`Include.Neuro.Pasc..1...yes..0...no.` == 1) %>% 
  select(phecode, description, group)

datatable(neuro_phecodes %>% arrange(phecode),
          filter = "top")
```

# Import All PheCodes

We will also add ICD-10 diagnosis codes to PheCode table

```{r}
# import the dataframe of all phecodes processed in R/process_all_phecodes.R
phecodes_all <- read.csv("data/all_phecodes.csv")

neuro_phecodes_icd <- neuro_phecodes %>% 
  left_join(., phecodes_all %>% 
              rename(Phenotype = "phecode_str",
                     `ICD10.String` = "icd10cm_str",
                     ICD10 = "icd10cm") %>% 
              select(phecode, Phenotype, ICD10, ICD10.String), 
            by = "phecode")
```

### Select COVID-19 positive patients

We will select patients who had a positive PCR test or a COVID-19 diagnosis

```{r}
positive <- c("Pos", "U071")

covid_pos <- observations %>% 
  filter(str_detect(cohort, paste(positive, collapse = "|")))

rm(observations)
```

**Collapse patient cohorts regardless of time period**

```{r}
covid_pos <- covid_pos %>% 
  mutate(status = if_else(str_detect(cohort, "NotAdm"), "Not Admitted", "Inpatient")) %>% 
  select(patient_num, status, days_since_admission, concept_code)

#covid_pos %>% distinct(cohort, status)
```

### Evaluate patients with NeuroPasc codes within 90 days post admission

```{r}
phecodes_pasc <- covid_pos %>%
  inner_join(., neuro_phecodes_icd %>%  
            rename(concept_code = "ICD10"), 
            by = "concept_code") 

phecodes_pasc_90 <- phecodes_pasc %>% 
  filter(days_since_admission >= 90)
```

#### Prevelent PheCodes after 90 days

```{r fig.height=16, fig.width=10}
# calculate the unique number of inpatients/outpatients
# this will allow us to calculate percents
inpatient_n = nrow(covid_pos %>% 
  filter(status == 'Inpatient') %>% 
  distinct(patient_num)) 

not_admitted_n = nrow(covid_pos %>% 
  filter(status == 'Not Admitted') %>% 
  distinct(patient_num)) 

phe_pasc90 <- phecodes_pasc_90 %>% 
  group_by(Phenotype, status) %>% 
  mutate(count = n_distinct(patient_num),
         percent = round(if_else(status == "Inpatient", 
                        count/inpatient_n*100, 
                        count/not_admitted_n*100),1)) %>% 
  ungroup() %>% 
  distinct(phecode, Phenotype, count, group, status, percent) %>% 
  group_by(Phenotype) %>% 
  arrange(Phenotype, status) %>% 
  mutate(perc_diff = lag(percent) - percent,
         perc_diff = if_else(is.na(perc_diff), lead(perc_diff), perc_diff),
         perc_diff = if_else(percent > lead(perc_diff), perc_diff, -1*perc_diff)) %>% 
  arrange(desc(perc_diff)) %>% 
  ungroup()

phe_plot_pasc90 <- ggplot(phe_pasc90,
       aes(y = Phenotype, x = percent, color = status, label = count)) + 
  geom_point() +  
  facet_wrap(~group, scales = "free_y", ncol = 1) + 
  theme_bw() 

ggplotly(phe_plot_pasc90) %>% layout(
      margin = list(b = 50)) # to fully display the x and y axis labels

datatable(phe_pasc90, filter = "top")
```

### Evaluate ALL neuro/mental health codes 

- perhaps want to review other circulatory codes?

```{r}
all_neuro_phecodes <- phecodes_all %>% 
  filter(group %in% c("mental disorders", "neurological", "sense organs", "symptoms") |
           phecode %in% neuro_phecodes$phecode) %>% 
  rename(Phenotype = "phecode_str",
         `ICD10.String` = "icd10cm_str",
         concept_code = "icd10cm") %>% 
  select(phecode, Phenotype, group, concept_code, ICD10.String)


all_neuro_pasc_phecodes_90 <- covid_pos %>% 
  merge(., all_neuro_phecodes,
              by = "concept_code") %>% 
  filter(days_since_admission >= 90)
```

```{r fig.height=46, fig.width=10}
all_phe_pasc90 <- all_neuro_pasc_phecodes_90 %>% 
  group_by(Phenotype, status) %>% 
  mutate(count = n_distinct(patient_num),
         percent = round(if_else(status == "Inpatient", 
                        count/inpatient_n*100, 
                        count/not_admitted_n*100),1)) %>% 
  ungroup() %>% 
  distinct(phecode, Phenotype, count, group, status, percent) %>% 
  group_by(Phenotype) %>% 
  arrange(Phenotype, status) %>% 
  mutate(perc_diff = lag(percent) - percent,
         perc_diff = if_else(is.na(perc_diff), lead(perc_diff), perc_diff),
         perc_diff = if_else(percent > lead(perc_diff), perc_diff, -1*perc_diff)) %>% 
  arrange(desc(perc_diff)) %>% 
  ungroup()

all_phe_plot_pasc90 <- ggplot(all_phe_pasc90,
       aes(y = Phenotype, x = percent, color = status, label = count)) + 
  geom_point() +  
  facet_wrap(~group, scales = "free_y", ncol = 1) + 
  theme_bw() 

ggplotly(all_phe_plot_pasc90) %>% layout(
      margin = list(b = 50)) # to fully display the x and y axis labels

datatable(all_phe_pasc90, filter = "top")
```

### Identify First Onset

Roll up all phecodes and identify a patientâ€™s earliest phecode. We will then later select for only patients who had the earliest phecode after 90 days COVID-19 hospital admission.

```{r fig.height=46, fig.width=10}
# find earliest code for a patient
covid_phecodes_roll <-  covid_pos %>% 
  inner_join(., all_neuro_phecodes, by = "concept_code") %>% 
  mutate(PheCode_roll = as.numeric(substr(phecode, 1, 3))) %>% 
  group_by(patient_num, PheCode_roll) %>% 
  slice_min(order_by = days_since_admission) 

phe_no_comorb90 <- covid_phecodes_roll %>% 
  filter(days_since_admission >= 90) %>% 
  group_by(Phenotype, status) %>% 
  mutate(count = n_distinct(patient_num),
         percent = round(if_else(status == "Inpatient", 
                        count/inpatient_n*100, 
                        count/not_admitted_n*100),1)) %>% 
  ungroup() %>% 
  distinct(phecode, Phenotype, count, group, status, percent) %>% 
  group_by(Phenotype) %>% 
  arrange(Phenotype, status) %>% 
  mutate(perc_diff = lag(percent) - percent,
         perc_diff = if_else(is.na(perc_diff), lead(perc_diff), perc_diff),
         perc_diff = if_else(percent > lead(perc_diff), perc_diff, -1*perc_diff)) %>% 
  arrange(desc(perc_diff)) %>% 
  ungroup()

phe_no_comorb_plot90 <- ggplot(phe_no_comorb90,
       aes(y = Phenotype, x = percent, label = count, color = status)) + 
  geom_point() +  
  facet_wrap(~ group, scales = "free_y", ncol = 1) + 
  theme_bw() + 
  theme(legend.position = "none")

ggplotly(phe_no_comorb_plot90) %>% layout(
      margin = list(b = 50)) # to fully display the x and y axis labels

datatable(phe_no_comorb90, filter = "top")
```

### Save counts

```{r}
write.csv(phe_pasc90, file = paste0(siteid, "_selected_phe_pasc90_codes.csv"), row.names = FALSE)
write.csv(all_phe_pasc90, file = paste0(siteid, "_all_selected_group_phe_pasc90_codes.csv"), row.names = FALSE)
write.csv(phe_no_comorb90, file = paste0(siteid, "_all_selected_group_first_onset.csv"), row.names = FALSE)
```


